<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Provisions & D√©penses Fixes</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .loading { color: orange; }
        button { margin: 10px; padding: 8px 16px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test API Provisions & D√©penses Fixes</h1>
        
        <div class="test-section">
            <h3>üîë Authentification</h3>
            <p>Token: <span id="token-status">V√©rification...</span></p>
            <p>API Base: <span id="api-base">http://127.0.0.1:8000</span></p>
        </div>

        <div class="test-section">
            <h3>üéØ Test Provisions</h3>
            <button onclick="testProvisions()">Test GET /custom-provisions</button>
            <button onclick="createTestProvision()">Test CREATE provision</button>
            <div id="provisions-result"></div>
        </div>

        <div class="test-section">
            <h3>üí≥ Test D√©penses Fixes</h3>
            <button onclick="testFixedExpenses()">Test GET /fixed-lines</button>
            <button onclick="createTestFixedExpense()">Test CREATE d√©pense</button>
            <div id="fixed-expenses-result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Test Dashboard</h3>
            <button onclick="testDashboard()">Test Dashboard API calls</button>
            <div id="dashboard-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        
        // Check authentication status
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const tokenType = localStorage.getItem('token_type') || 'Bearer';
            
            document.getElementById('token-status').innerHTML = token ? 
                `<span class="success">‚úÖ Token pr√©sent (${tokenType})</span>` : 
                `<span class="error">‚ùå Pas de token - Connectez-vous d'abord</span>`;
                
            document.getElementById('api-base').textContent = API_BASE;
            
            return !!token;
        }

        // Helper function to make authenticated API calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            const token = localStorage.getItem('auth_token');
            const tokenType = localStorage.getItem('token_type') || 'Bearer';
            
            if (!token) {
                throw new Error('Pas de token d\'authentification');
            }

            const config = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `${tokenType} ${token}`
                }
            };

            if (data && method !== 'GET') {
                config.body = JSON.stringify(data);
            }

            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            return response.json();
        }

        // Test provisions
        async function testProvisions() {
            const resultDiv = document.getElementById('provisions-result');
            resultDiv.innerHTML = '<p class="loading">üîÑ Test en cours...</p>';
            
            try {
                const provisions = await apiCall('/custom-provisions');
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Succ√®s! ${provisions.length} provision(s) trouv√©e(s)</p>
                    <pre>${JSON.stringify(provisions, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Erreur: ${error.message}</p>
                `;
            }
        }

        // Create test provision
        async function createTestProvision() {
            const resultDiv = document.getElementById('provisions-result');
            resultDiv.innerHTML = '<p class="loading">üîÑ Cr√©ation provision test...</p>';
            
            const testProvision = {
                name: "Test √âpargne",
                description: "Provision de test cr√©√©e par l'interface",
                percentage: 10,
                base_calculation: "total",
                fixed_amount: null,
                split_mode: "50/50",
                split_member1: 50,
                split_member2: 50,
                icon: "üí∞",
                color: "#6366f1",
                display_order: 1,
                is_active: true,
                is_temporary: false,
                category: "savings"
            };
            
            try {
                const newProvision = await apiCall('/custom-provisions', 'POST', testProvision);
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Provision cr√©√©e avec succ√®s!</p>
                    <pre>${JSON.stringify(newProvision, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Erreur cr√©ation: ${error.message}</p>
                `;
            }
        }

        // Test fixed expenses
        async function testFixedExpenses() {
            const resultDiv = document.getElementById('fixed-expenses-result');
            resultDiv.innerHTML = '<p class="loading">üîÑ Test en cours...</p>';
            
            try {
                const expenses = await apiCall('/fixed-lines');
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Succ√®s! ${expenses.length} d√©pense(s) fixe(s) trouv√©e(s)</p>
                    <pre>${JSON.stringify(expenses, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Erreur: ${error.message}</p>
                `;
            }
        }

        // Create test fixed expense
        async function createTestFixedExpense() {
            const resultDiv = document.getElementById('fixed-expenses-result');
            resultDiv.innerHTML = '<p class="loading">üîÑ Cr√©ation d√©pense test...</p>';
            
            const testExpense = {
                label: "Test Cr√©dit",
                amount: 800.0,
                freq: "mensuelle",
                split_mode: "cl√©",
                split1: 60,
                split2: 40,
                active: true
            };
            
            try {
                const newExpense = await apiCall('/fixed-lines', 'POST', testExpense);
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ D√©pense cr√©√©e avec succ√®s!</p>
                    <pre>${JSON.stringify(newExpense, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Erreur cr√©ation: ${error.message}</p>
                `;
            }
        }

        // Test dashboard data loading
        async function testDashboard() {
            const resultDiv = document.getElementById('dashboard-result');
            resultDiv.innerHTML = '<p class="loading">üîÑ Test dashboard en cours...</p>';
            
            try {
                const [config, summary, provisions, fixedExpenses] = await Promise.all([
                    apiCall('/config'),
                    apiCall('/summary?month=2024-08'),
                    apiCall('/custom-provisions'),
                    apiCall('/fixed-lines')
                ]);

                const results = {
                    config: config,
                    summary: summary,
                    provisions: provisions.length,
                    fixedExpenses: fixedExpenses.length
                };

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Donn√©es dashboard charg√©es avec succ√®s!</p>
                    <p>Configuration: ‚úÖ</p>
                    <p>R√©sum√©: ‚úÖ</p>
                    <p>Provisions: ${provisions.length}</p>
                    <p>D√©penses fixes: ${fixedExpenses.length}</p>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Erreur dashboard: ${error.message}</p>
                `;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>